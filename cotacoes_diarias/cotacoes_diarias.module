<?php

/**
 * @file
 * MÃ³dulo para exibir cotaÃ§Ãµes diÃ¡rias no Drupal 7.
 */

include_once(drupal_get_path('module', 'cotacoes_diarias') . '/includes/cotacoes_api.inc');

/**
 * Limpa o cache das cotaÃ§Ãµes.
 * Ãštil para forÃ§ar uma nova busca dos dados.
 */
function cotacoes_diarias_clear_cache() {
  cache_clear_all('cotacoes_diarias_cache', 'cache');
  watchdog('cotacoes_diarias', 'Cache limpo manualmente', [], WATCHDOG_INFO);
}

/**
 * Implements hook_block_info().
 */
function cotacoes_diarias_block_info() {
  $blocks['cotacoes_diarias'] = array(
    'info' => t('CotaÃ§Ãµes do dia'),
  );
  return $blocks;
}

/**
 * Implements hook_block_view().
 */
function cotacoes_diarias_block_view($delta = '') {
  $block = array();

  if ($delta == 'cotacoes_diarias') {

    // ðŸ”¹ Tenta buscar do cache antes de chamar a API
    $cid = 'cotacoes_diarias_cache';
    $cache = cache_get($cid, 'cache');

    // Verifica se o cache Ã© vÃ¡lido e se contÃ©m a chave 'atualizado_em'
    if ($cache && !empty($cache->data) && isset($cache->data['atualizado_em']) && (REQUEST_TIME - $cache->created < 3600)) {
      // Cache vÃ¡lido (menos de 1h)
      $cotacoes = $cache->data;
    }
    else {
      // ðŸ”¹ Sem cache ou expirado: busca novos dados
      $cotacoes = cotacoes_diarias_get_data();

      // Armazena no cache por 1 hora
      cache_set($cid, $cotacoes, 'cache', REQUEST_TIME + 3600);
    }

    // ðŸ”¹ Escapa os valores antes de imprimir
    $dolar = check_plain($cotacoes['dolar']);
    $milho = check_plain($cotacoes['milho']);
    $soja  = check_plain($cotacoes['soja']);
    $data  = check_plain($cotacoes['atualizado_em']);

    // ðŸ”¹ Monta o HTML seguro
    $output  = '<div class="cotacoes-diarias">';
    $output .= '<strong>ðŸ’µ ' . t('DÃ³lar:') . '</strong> R$ ' . $dolar . ' | ';
    $output .= '<strong>ðŸŒ½ ' . t('Milho:') . '</strong> R$ ' . $milho . '/sc | ';
    $output .= '<strong>ðŸŒ± ' . t('Soja:')  . '</strong> R$ ' . $soja . '/sc';
    $output .= '<br><small>' . t('Atualizado: @data', array('@data' => $data)) . '</small>';
    $output .= '<br><small style="color:#666;font-size:10px;">* ' . t('Milho e Soja: valores aproximados do mercado internacional') . '</small>';
    $output .= '</div>';

    // ðŸ”¹ Retorna tÃ­tulo e conteÃºdo
    $block['subject'] = t('CotaÃ§Ãµes do dia');
    $block['content'] = array('#markup' => $output);
  }

  return $block;
}
